{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"location": {
			"type": "string",
			"defaultValue": "[resourceGroup().location]"
		},
		"appServicePlan": {
			"type": "string",
			"defaultValue": "devstereolizewebserver",
			"metadata": {
				"description": "Linux plan hosting the directus container"
			}
		},
		"siteName": {
			"type": "string",
			"defaultValue": "devappnamecms",
			"metadata": {
				"description": "The name of the web app that you wish to create."
			}
		},
		"directusVersion": {
			"type": "string",
			"defaultValue": "latest",
			"metadata": {
				"description": "Directus Version, like 9.26.0 or latest"
			}
		},
		"directusAdministratorEmail": {
			"type": "string",
			"metadata": {
				"description": "Directus administrative account email"
			}
		},
		"directusAdministratorPassword": {
			"type": "secureString",
			"metadata": {
				"description": "Directus administrative account password"
			}
		},
		
		/* ---------------- Email: shared + transport choice ---------------- */
		"emailTransport": {
		  "type": "string",
		  "defaultValue": "smtp",
		  "allowedValues": [ "smtp", "mailgun" ],
		  "metadata": { "description": "Choose how Directus sends email: smtp or mailgun" }
		},			
		"directus_EMAIL_FROM": {
			"type": "string",
			"defaultValue": "support@stereolize.de",
			"metadata": {
				"description": "Email Directus uses to communicate with users"
			}
		},
		
		/* ---------------- SMTP settings ---------------- */
		"directus_EMAIL_SMTP_HOST": {
			"type": "string",
			"defaultValue": "smtp.ionos.de",
			"metadata": {
				"description": "SMTP Host"
			}
		},
		"directus_EMAIL_SMTP_PASSWORD": {
			"type": "secureString",
			"metadata": {
				"description": "SMTP Password for email directus uses to communicate"
			}
		},
		
		/* ---------------- Mailgun settings ---------------- */
		"directus_EMAIL_MAILGUN_API_KEY": {
		  "type": "secureString",
		  "defaultValue": "",
		  "metadata": { "description": "Mailgun API key (Domain Sending Key or Account API Key)" }
		},
		"directus_EMAIL_MAILGUN_DOMAIN": {
		  "type": "string",
		  "defaultValue": "",
		  "metadata": { "description": "Mailgun sending domain (e.g. mg.example.com)" }
		},
		"directus_EMAIL_MAILGUN_HOST": {
		  "type": "string",
		  "defaultValue": "api.mailgun.net",
		  "metadata": { "description": "Mailgun API host (use api.eu.mailgun.net for EU region if needed)" }
		},
		
		/* ---------------- Database & Storage ---------------- */
		"dbClient": {
			"type": "string",
			"defaultValue": "mysql",
			"metadata": {
				"description": "The SQL you want to use, e.g. mysql or mssql"
			}
		},
		"dbPort": {
			"type": "int",
			"defaultValue": 3306,
			"metadata": {
				"description": "The db port you want to use. E.g. 3306 for MySQL or 1433 for MsSQL"
			}
		},
		"serverName": {
			"type": "string",
			"defaultValue": "devstereolizemysqlserver",
			"metadata": {
				"description": "The name of an existing MySQL server."
			}
		},
		"serverUser": {
			"type": "string",
			"defaultValue": "devmysqladmin",
			"metadata": {
				"description": "Admin user name for SQL server"
			}
		},
		"serverPassword": {
			"type": "secureString",
			"metadata": {
				"description": "Admin password for SQL server"
			}
		},
		"databaseName": {
			"type": "string",
			"defaultValue": "devprojectnamemysqldb",
			"metadata": {
				"description": "The name of the database that you wish to create."
			}
		},
		"storageAccountName": {
			"type": "string",
			"defaultValue": "devstereolizestorage",
			"metadata": {
				"description": "Name of the storage account that will host the file uploads"
			}
		},
		"storageContainerName": {
			"type": "string",
			"defaultValue": "directusfiles",
			"metadata": {
				"description": "Name of the Container inside the storage account that will host the file uploads"
			}
		}
	},
	"resources": [		
		{
			"type": "Microsoft.Web/sites",
			"apiVersion": "2021-02-01",
			"name": "[parameters('siteName')]",
			"location": "[parameters('location')]",
			"kind": "app,linux,container",
			"properties": {
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat(parameters('siteName'), '.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat(parameters('siteName'), '.scm.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlan'))]",
				"reserved": true,
				"isXenon": false,
				"hyperV": false,
				"siteConfig": {
					"numberOfWorkers": 1,
					"linuxFxVersion": "[concat('DOCKER|directus/directus:', parameters('directusVersion'))]",
					"alwaysOn": false,
					"http20Enabled": false
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": false,
				"clientCertEnabled": false,
				"hostNamesDisabled": false,
				"containerSize": 0,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": false,
				"redundancyMode": "None"
			}
		},
		{
			"type": "Microsoft.Web/sites/config",
			"apiVersion": "2021-02-01",
			"name": "[concat(parameters('siteName'), '/web')]",
			"location": "[parameters('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/sites', parameters('siteName'))]"
			],
			"properties": {
				"appSettings": [
					{
						"name": "ADMIN_EMAIL",
						"value": "[parameters('directusAdministratorEmail')]"
					},
					{
						"name": "ADMIN_PASSWORD",
						"value": "[parameters('directusAdministratorPassword')]"
					},
					{
						"name": "CACHE_ENABLED",
						"value": false
					},
					{
						"name": "CORS_ALLOWED_HEADERS",
						"value": "Content-Type,Authorization"
					},
					{
						"name": "CORS_ENABLED",
						"value": true
					},
					{
						"name": "CORS_METHODS",
						"value": "GET,POST,PATCH,DELETE"
					},
					{
						"name": "CORS_ORIGIN",
						"value": true
					},
					{
						"name": "DB_CLIENT",
						"value": "[parameters('dbClient')]"
					},
					{
						"name": "DB_DATABASE",
						"value": "[parameters('databaseName')]"
					},
					{
						"name": "DB_ENCRYPT",
						"value": "true"
					},
					{
						"name": "DB_HOST",
						"value": "[concat(parameters('serverName'), '.mysql.database.azure.com')]"
					},
					{
						"name": "DB_PASSWORD",
						"value": "[parameters('serverPassword')]"
					},
					{
						"name": "DB_PORT",
						"value": "[parameters('dbPort')]"
					},
					{
						"name": "DB_USER",
						"value": "[parameters('serverUser')]"
					},
					
					/* ------------- Email (shared + transport) ------------- */
					{
						"name": "EMAIL_FROM",
						"value": "[parameters('directus_EMAIL_FROM')]"
					},
					{ 	"name": "EMAIL_TRANSPORT", 
						"value": "[parameters('emailTransport')]"
					},
					
					/* SMTP (used when EMAIL_TRANSPORT = smtp) */
					{
						"name": "EMAIL_SMTP_HOST",
						"value": "[parameters('directus_EMAIL_SMTP_HOST')]"
					},
					{
						"name": "EMAIL_SMTP_PASSWORD",
						"value": "[parameters('directus_EMAIL_SMTP_PASSWORD')]"
					},
					{
						"name": "EMAIL_SMTP_PORT",
						"value": 587
					},
					{
						"name": "EMAIL_SMTP_SECURE",
						"value": false
					},
					{
						"name": "EMAIL_SMTP_USER",
						"value": "[parameters('directus_EMAIL_FROM')]"
					},
					
					/* Mailgun (used when EMAIL_TRANSPORT = mailgun) */
					{	"name": "EMAIL_MAILGUN_API_KEY",
						"value": "[parameters('directus_EMAIL_MAILGUN_API_KEY')]"
					},
					{	"name": "EMAIL_MAILGUN_DOMAIN",
						"value": "[parameters('directus_EMAIL_MAILGUN_DOMAIN')]"
					},
					{	"name": "EMAIL_MAILGUN_HOST", 
						"value": "[parameters('directus_EMAIL_MAILGUN_HOST')]"
					},			

					/* Database & Storage */					
					{
						"name": "KEY",
						"value": "[guid(resourceGroup().id)]"
					},
					{
						"name": "PASSWORD_RESET_URL_ALLOW_LIST",
						"value": "[concat('https://', parameters('siteName'), '.azurewebsites.net')]"
					},
					{
						"name": "PUBLIC_URL",
						"value": "[concat('https://', parameters('siteName'), '.azurewebsites.net')]"
					},
					{
						"name": "RATE_LIMITER_ENABLED",
						"value": false
					},
					{
						"name": "SECRET",
						"value": "[concat(uniqueString(resourceGroup().id), uniqueString(guid(resourceGroup().id)))]"
					},
					{
						"name": "STORAGE_LOCATIONS",
						"value": "azure"
					},
					{
						"name": "STORAGE_AZURE_DRIVER",
						"value": "azure"
					},
					{
						"name": "STORAGE_AZURE_CONTAINER_NAME",
						"value": "[parameters('storageContainerName')]"
					},
					{
						"name": "STORAGE_AZURE_ACCOUNT_NAME",
						"value": "[parameters('storageAccountName')]"
					},
					{
						"name": "STORAGE_AZURE_ACCOUNT_KEY",
						"value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-04-01').keys[0].value]"
					},
					{
						"name": "WEBSOCKETS_ENABLED",
						"value": true
					}
				]
			}
		}
	],
	"outputs": {
		"uniqueId": {
			"type": "string",
			"value": "[uniqueString(resourceGroup().id)]"
		}
	}
}